<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Wali Gesit - Jatie Hartono</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; 
            --primary-hover: #4338ca;
            --success: #10b981; 
            --danger: #ef4444; 
            --bg: #f3f4f6; 
            --text-dark: #1f2937;
            --text-light: #6b7280;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            margin: 0; padding: 0; 
            color: var(--text-dark);
            line-height: 1.6;
        }

        .loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 9999; backdrop-filter: blur(8px);
        }
        .spinner { 
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); 
            border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container { 
            max-width: 550px; margin: 40px auto; background: white; 
            padding: 35px; border-radius: 24px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header h2 { font-weight: 700; color: var(--text-dark); margin-bottom: 5px; }
        .header p { color: var(--text-light); font-size: 0.9rem; margin-top: 0; }

        /* Keterangan Form Section */
        .section-info {
            background: #eef2ff;
            padding: 12px 15px;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #3730a3;
            font-weight: 600;
        }

        .hidden { display: none !important; }

        label { display: block; margin-top: 15px; margin-bottom: 6px; font-weight: 700; font-size: 0.85rem; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.5px; }
        input, textarea { 
            width: 100%; padding: 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; 
            box-sizing: border-box; font-size: 0.95rem; transition: all 0.2s; background: #f9fafb;
        }
        input:focus, textarea:focus { 
            outline: none; border-color: var(--primary); background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); 
        }

        .btn { 
            padding: 14px; border: none; border-radius: 14px; cursor: pointer; 
            font-weight: 700; margin-top: 10px; transition: all 0.2s; 
            width: 100%; font-size: 1rem;
        }
        .btn:active { transform: scale(0.97); }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-back { background: transparent; color: var(--text-light); border: 1.5px solid #e5e7eb; width: auto; padding: 8px 20px; margin-bottom: 20px; }

        .data-card { max-width: 850px !important; }
        .table-wrapper { overflow-x: auto; border-radius: 16px; border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9fafb; padding: 15px; text-align: left; font-size: 0.75rem; color: var(--text-light); border-bottom: 1.5px solid #e5e7eb; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; }
    </style>
</head>
<body>

<div id="loading" class="hidden loading-overlay">
    <div class="spinner"></div>
    <p style="font-weight: 600; margin-top: 15px; color: var(--primary)">Sedang memproses...</p>
</div>

<div id="page-login" class="container">
    <div class="header">
        <h2 style="font-size: 1.8rem;">üîê Login Akses</h2>
        <p>Gunakan akun Guru Wali untuk melanjutkan</p>
    </div>
    <label>Nama Pengguna</label>
    <input type="text" id="username" placeholder="Masukkan Username">
    <label>Kata Sandi</label>
    <input type="password" id="password" placeholder="Masukkan Sandi">
    <button class="btn btn-primary" onclick="handleLogin()">Masuk ke Aplikasi</button>
</div>

<div id="main-content" class="hidden">
    <div id="page-menu" class="container">
        <div class="header">
            <h2>Pusat Kendali</h2>
            <p>Aplikasi Monitoring Bimbingan Siswa</p>
        </div>
        <button class="btn btn-success" onclick="showPage('page-form')">üìù Tambah Data Baru</button>
        <button class="btn btn-primary" onclick="fetchData()">üìä Rekap Data Online</button>
        <button class="btn btn-back" style="width: 100%; margin-top: 20px;" onclick="location.reload()">Keluar Sesi</button>
    </div>

    <div id="page-form" class="hidden container">
        <button class="btn btn-back" onclick="showPage('page-menu')">‚Üê Kembali</button>
        <div class="header">
            <h2>Input Laporan</h2>
            <p>Silakan isi detail bimbingan di bawah ini</p>
        </div>

        <div class="section-info">üìå INFORMASI KEJADIAN & SISWA</div>
        
        <form id="bimbinganForm">
            <label>üìÖ Tanggal</label>
            <input type="date" id="tanggal" required title="Pilih tanggal kejadian">
            
            <label>üÜî Nomor Induk Siswa (NIS)</label>
            <input type="text" id="nis" placeholder="Contoh: 202301" required>
            
            <label>üë§ Nama Lengkap Siswa</label>
            <input type="text" id="nama" placeholder="Masukkan Nama Siswa" required>
            
            <label>üìù Catatan Masalah</label>
            <textarea id="catatan" rows="3" placeholder="Uraikan masalah atau kasus siswa..."></textarea>
            
            <label>üí° Tindak Lanjut</label>
            <textarea id="tindakLanjut" rows="3" placeholder="Solusi atau tindakan yang telah diberikan..."></textarea>

            <div class="section-info" style="margin-top:25px;">üè† INFORMASI ORANG TUA / WALI</div>
            
            <label>üìç Alamat Rumah</label>
            <input type="text" id="alamat" placeholder="Alamat lengkap">
            
            <label>üë®‚Äçüë©‚Äçüë¶ Nama Orang Tua</label>
            <input type="text" id="namaOrtu" placeholder="Ayah / Ibu">
            
            <label>üìû No. Telepon / WhatsApp</label>
            <input type="text" id="telp" placeholder="Contoh: 08123456789">
            
            <label>üíº Pekerjaan Orang Tua</label>
            <input type="text" id="pekerjaan" placeholder="Contoh: Pegawai Swasta">
            
            <button type="submit" class="btn btn-success" style="margin-top: 25px;">Simpan Laporan Sekarang</button>
        </form>
    </div>

    <div id="page-data" class="hidden container data-card">
        <button class="btn btn-back" onclick="showPage('page-menu')">‚Üê Kembali</button>
        <div class="header">
            <h2>Data Tersimpan</h2>
            <p>Daftar seluruh bimbingan yang telah masuk</p>
        </div>
        <button class="btn btn-primary" style="margin-bottom: 20px; width: auto;" onclick="downloadExcel()">üì• Export ke Excel</button>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>TANGGAL</th>
                        <th>NAMA LENGKAP</th>
                        <th style="text-align:center">KENDALI</th>
                    </tr>
                </thead>
                <tbody id="data-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // URL Web App Google Script Anda
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxPZDdVJiQAPCgd-DlnFpnuKgDy33A5FPKy3NJInCbTYhcB2juG1FRPUvSMBUeGzfHshw/exec";
    
    let bimbinganData = [];

    function formatDateOnly(dateStr) {
        if (!dateStr) return '';
        return dateStr.split('T')[0].split(' ')[0];
    }

    function handleLogin() {
        if(document.getElementById('username').value === "gesit" && document.getElementById('password').value === "admin123") {
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            showPage('page-menu');
        } else { alert("Maaf, Username atau Sandi salah!"); }
    }

    function showPage(id) {
        ['page-menu', 'page-form', 'page-data'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        window.scrollTo(0, 0);
    }

    function toggleLoading(show) {
        document.getElementById('loading').classList[show ? 'remove' : 'add']('hidden');
    }

    function fetchData() {
        toggleLoading(true);
        fetch(SCRIPT_URL + "?action=read")
        .then(res => res.json())
        .then(data => {
            bimbinganData = data;
            renderTable();
            showPage('page-data');
        })
        .catch(err => alert("Koneksi terputus: " + err))
        .finally(() => toggleLoading(false));
    }

    function renderTable() {
        const tbody = document.getElementById('data-body');
        tbody.innerHTML = '';
        bimbinganData.forEach(item => {
            tbody.innerHTML += `<tr>
                <td style="color:#6b7280">${formatDateOnly(item.Tanggal)}</td>
                <td style="font-weight:600">${item.Nama || ''}</td>
                <td style="text-align:center">
                    <button onclick="deleteData('${item.NIS}')" 
                    style="background:#fee2e2; color:#b91c1c; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:700;">
                    Hapus</button>
                </td>
            </tr>`;
        });
    }

    function deleteData(nis) {
        if(confirm("Hapus data siswa dengan NIS: " + nis + "?")) {
            toggleLoading(true);
            fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "delete", nis: String(nis) }) 
            })
            .then(() => {
                alert("Data berhasil dihapus dari cloud.");
                fetchData();
            })
            .catch(err => alert("Gagal menghapus: " + err))
            .finally(() => toggleLoading(false));
        }
    }

    document.getElementById('bimbinganForm').onsubmit = function(e) {
        e.preventDefault();
        toggleLoading(true);
        
        const payload = {
            action: "add",
            tanggal: document.getElementById('tanggal').value,
            nis: document.getElementById('nis').value.trim(),
            nama: document.getElementById('nama').value,
            catatan: document.getElementById('catatan').value,
            tindakLanjut: document.getElementById('tindakLanjut').value,
            alamat: document.getElementById('alamat').value,
            namaOrtu: document.getElementById('namaOrtu').value,
            telp: document.getElementById('telp').value.trim(),
            pekerjaan: document.getElementById('pekerjaan').value
        };

        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
        .then(() => { 
            alert("‚úÖ Berhasil menyimpan data bimbingan!"); 
            document.getElementById('bimbinganForm').reset();
            showPage('page-menu');
        })
        .catch(err => alert("Gagal menyimpan: " + err))
        .finally(() => toggleLoading(false));
    };

    function downloadExcel() {
        const cleanedData = bimbinganData.map(item => ({
            ...item,
            Tanggal: formatDateOnly(item.Tanggal)
        }));
        const ws = XLSX.utils.json_to_sheet(cleanedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Database_Gesit");
        XLSX.writeFile(wb, "Rekap_Bimbingan_Konseling.xlsx");
    }
</script>
</body>
</html>
